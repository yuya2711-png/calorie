<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カロリー計算機</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }

    input, select, button {
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      width: 100%;
      margin-bottom: 6px;
    }

    .food-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 0.6fr;
      gap: 6px;
      margin-bottom: 10px;
    }

    .cal-display {
      background: #eee;
      text-align: right;
    }

    .delete-btn {
      background: #ff6666;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-weight: bold;
    }

    .edit-btn {
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 4px;
    }

    .saved-food-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 6px;
    }

    .saved-food-actions {
      display: flex;
      gap: 4px;
    }

    .custom-food {
      display: none;
      background: #f0f8ff;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .result {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin: 6px 0 12px;
    }
  </style>
</head>

<body>
<div class="container">
  <h2>カロリー計算機</h2>

  <label>一回の総カロリー</label>
  <input type="number" id="totalCalories" value="150">

  <h3>食事内容</h3>
  <div id="foods"></div>

  <button onclick="calculate()">計算</button>

  <div class="result">
    残りカロリー：<span id="result">0</span> kcal
  </div>

  <button onclick="addFood()">＋ 食材を追加</button>

  <button onclick="toggleCustomFood()">
    食材がリストにない場合はこちら
  </button>

  <!-- 新規・編集共通フォーム -->
  <div class="custom-food" id="customFoodArea">
    <h3 id="customTitle">食材を追加</h3>

    <input id="customName" placeholder="食材名">
    <input id="customGram" type="number" placeholder="総量（g）">
    <input id="customTotalCal" type="number" placeholder="総カロリー（kcal）">

    <button onclick="saveCustomFood()">保存</button>
  </div>

  <h3>追加済み食材</h3>
  <div id="savedFoodList"></div>
</div>

<script src="food.js"></script>

<script>
  let foodMaster =
    JSON.parse(localStorage.getItem("foodMaster")) || { ...defaultFoods };

  let editingFoodName = null;

  addFood();
  renderSavedFoods();

  function addFood() {
    const foods = document.getElementById("foods");
    const row = document.createElement("div");
    row.className = "food-row";

    const select = document.createElement("select");
    updateFoodOptions(select);

    const gram = document.createElement("input");
    gram.type = "number";
    gram.placeholder = "g";

    const cal = document.createElement("input");
    cal.disabled = true;
    cal.className = "cal-display";

    const del = document.createElement("button");
    del.textContent = "×";
    del.className = "delete-btn";
    del.onclick = () => row.remove();

    gram.oninput = () => {
      cal.value = gram.value
        ? Math.round(gram.value * foodMaster[select.value])
        : "";
    };

    row.append(select, gram, cal, del);
    foods.appendChild(row);
  }

  function updateFoodOptions(select) {
    select.innerHTML = "";
    Object.keys(foodMaster).forEach(food => {
      const option = document.createElement("option");
      option.value = food;
      option.textContent = food;
      select.appendChild(option);
    });
  }

  function toggleCustomFood() {
    const area = document.getElementById("customFoodArea");
    area.style.display = area.style.display === "none" ? "block" : "none";
    resetCustomForm();
  }

  function saveCustomFood() {
    const name = customName.value.trim();
    const gram = Number(customGram.value);
    const totalCal = Number(customTotalCal.value);

    if (!name || gram <= 0 || totalCal <= 0) {
      return;
    }

    const perGramCal = totalCal / gram;

    if (editingFoodName && editingFoodName !== name) {
      delete foodMaster[editingFoodName];
    }

    foodMaster[name] = perGramCal;
    localStorage.setItem("foodMaster", JSON.stringify(foodMaster));

    renderSavedFoods();
    document.querySelectorAll("select").forEach(updateFoodOptions);
    resetCustomForm();
  }

  function renderSavedFoods() {
    const list = document.getElementById("savedFoodList");
    list.innerHTML = "";

    Object.keys(foodMaster).forEach(food => {
      if (defaultFoods[food]) return;

      const div = document.createElement("div");
      div.className = "saved-food-item";

      const span = document.createElement("span");
      span.textContent = `${food} (${foodMaster[food].toFixed(2)} kcal/g)`;

      const actions = document.createElement("div");
      actions.className = "saved-food-actions";

      const editBtn = document.createElement("button");
      editBtn.textContent = "編集";
      editBtn.className = "edit-btn";
      editBtn.onclick = () => editFood(food);

      const delBtn = document.createElement("button");
      delBtn.textContent = "削除";
      delBtn.className = "delete-btn";
      delBtn.onclick = () => {
        delete foodMaster[food];
        localStorage.setItem("foodMaster", JSON.stringify(foodMaster));
        renderSavedFoods();
        document.querySelectorAll("select").forEach(updateFoodOptions);
      };

      actions.append(editBtn, delBtn);
      div.append(span, actions);
      list.appendChild(div);
    });
  }

  function editFood(food) {
    const area = document.getElementById("customFoodArea");
    area.style.display = "block";

    editingFoodName = food;
    customTitle.textContent = "食材を編集";

    customName.value = food;
    customGram.value = "";
    customTotalCal.value = "";
  }

  function resetCustomForm() {
    editingFoodName = null;
    customTitle.textContent = "食材を追加";
    customName.value = "";
    customGram.value = "";
    customTotalCal.value = "";
  }

  function calculate() {
    const total = Number(totalCalories.value);
    let used = 0;

    document.querySelectorAll(".food-row").forEach(row => {
      used += Number(row.children[2].value || 0);
    });

    result.textContent = Math.round(total - used);
  }
</script>
</body>
</html>
