<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カロリー計算機</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }

    input, select, button {
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      margin: 6px 0;
      position: relative;
      z-index: 10;
    }

    .food-row {
      display: grid;
      grid-template-columns: 1.4fr 1fr 0.8fr 0.6fr;
      gap: 6px;
      margin-bottom: 10px;
    }

    .search-box {
      grid-column: 1 / -1;
    }

    .cal-display {
      background: #eee;
      text-align: right;
    }

    .delete-btn {
      background: #ff6666;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    .custom-food {
      display: none;
      background: #f0f8ff;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .saved-foods {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .saved-food-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    /* ★ 計算結果用 */
    .result {
      margin: 6px 0 12px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }

    @media (max-width: 600px) {
      .food-row {
        grid-template-columns: 1fr;
      }
      input, select, button {
        height: 44px;
      }
    }
  </style>
</head>

<body>
<div class="container">
  <h2>カロリー計算機</h2>

  <label>一回の総カロリー</label>
  <input type="number" id="totalCalories" value="150">

  <h3>食事内容</h3>
  <div id="foods"></div>

  <!-- 計算ボタン -->
  <button type="button" onclick="calculate()">計算</button>

  <!-- ★ 計算結果を直下に -->
  <div class="result">
    残りカロリー：<span id="result">0</span> kcal
  </div>

  <button type="button" id="addFoodBtn">＋ 食材を追加</button>

  <button type="button" onclick="toggleCustomFood()">
    食材がリストにない場合はこちら
  </button>

  <div class="custom-food" id="customFoodArea">
    <h3>食材を追加</h3>
    <input type="text" id="customName" placeholder="食材名">
    <input type="number" id="customCal" placeholder="1gあたりのカロリー" step="0.01">
    <button type="button" onclick="addCustomFood()">この食材を追加</button>
  </div>

  <div class="saved-foods">
    <h3>追加済み食材</h3>
    <div id="savedFoodList"></div>
  </div>
</div>

<script src="food.js"></script>

<script>
  let foodMaster =
    JSON.parse(localStorage.getItem("foodMaster")) || { ...defaultFoods };

  addFood();
  renderSavedFoods();

  const addBtn = document.getElementById("addFoodBtn");
  addBtn.addEventListener("click", addFood);
  addBtn.addEventListener("touchstart", addFood);

  function addFood() {
    const foodsDiv = document.getElementById("foods");
    const row = document.createElement("div");
    row.className = "food-row";

    const search = document.createElement("input");
    search.placeholder = "食材検索";
    search.className = "search-box";

    const select = document.createElement("select");
    updateFoodOptions(select);

    const weight = document.createElement("input");
    weight.type = "number";
    weight.placeholder = "量(g)";

    const cal = document.createElement("input");
    cal.disabled = true;
    cal.className = "cal-display";

    const del = document.createElement("button");
    del.type = "button";
    del.textContent = "×";
    del.className = "delete-btn";
    del.onclick = () => row.remove();

    search.oninput = () => updateFoodOptions(select, search.value);

    weight.oninput = () => {
      cal.value = weight.value
        ? Math.round(foodMaster[select.value] * weight.value)
        : "";
    };

    row.append(search, select, weight, cal, del);
    foodsDiv.appendChild(row);
  }

  function updateFoodOptions(select, keyword = "") {
    select.innerHTML = "";
    Object.keys(foodMaster).forEach(food => {
      if (!food.includes(keyword)) return;
      const option = document.createElement("option");
      option.value = food;
      option.textContent = food;
      select.appendChild(option);
    });
  }

  function toggleCustomFood() {
    const area = document.getElementById("customFoodArea");
    area.style.display = area.style.display === "none" ? "block" : "none";
  }

  function addCustomFood() {
    const name = customName.value.trim();
    const cal = Number(customCal.value);
    if (!name || cal <= 0) return alert("正しく入力してください");

    foodMaster[name] = cal;
    localStorage.setItem("foodMaster", JSON.stringify(foodMaster));
    renderSavedFoods();
    document.querySelectorAll("select").forEach(s => updateFoodOptions(s));
    customName.value = "";
    customCal.value = "";
  }

  function renderSavedFoods() {
    const list = document.getElementById("savedFoodList");
    list.innerHTML = "";

    Object.keys(foodMaster).forEach(food => {
      if (defaultFoods[food]) return;

      const div = document.createElement("div");
      div.className = "saved-food-item";

      const span = document.createElement("span");
      span.textContent = `${food} (${foodMaster[food]} kcal/g)`;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "削除";
      btn.onclick = () => removeCustomFood(food);

      div.append(span, btn);
      list.appendChild(div);
    });
  }

  function removeCustomFood(food) {
    if (!confirm(`${food} を削除しますか？`)) return;
    delete foodMaster[food];
    localStorage.setItem("foodMaster", JSON.stringify(foodMaster));
    renderSavedFoods();
    document.querySelectorAll("select").forEach(s => updateFoodOptions(s));
  }

  function calculate() {
    const total = Number(totalCalories.value);
    let used = 0;
    document.querySelectorAll(".food-row").forEach(row => {
      used += Number(row.children[3].value || 0);
    });
    result.textContent = Math.round(total - used);
  }
</script>
</body>
</html>
